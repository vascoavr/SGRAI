<!DOCTYimport { GUI } from './jsm/libs/dat.gui.module.js';import { GUI } from './jsm/libs/dat.gui.module.js';PE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<script src="node_modules/three/build/three.js"></script>
		<script src="js/utility.js"></script>
		<script src="models/factory_building/factory_building.js"></script>
		<script src="models/conveyor_belt/conveyor_belt.js"></script>
        <script type= "module">
            import {GUI} from '/node_modules/three/examples/jsm/libs/dat.gui.module.js';
            import {FirstPersonControls} from '/node_modules/three/examples/jsm/controls/FirstPersonControls.js';
            import {OrbitControls} from '/node_modules/three/examples/jsm/controls/OrbitControls.js';
            import {GLTFLoader} from '/node_modules/three/examples/jsm/loaders/GLTFLoader.js';
            
            let renderer, camera, scene, controls;
            let groupFactoryBuilding;
            
            var factoryBuilding;
            
            function init(){
                renderer = new THREE.WebGLRenderer({antialias: true});
                renderer.setSize( window.innerWidth, window.innerHeight );
                document.body.appendChild( renderer.domElement );

                camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 2000 );
                camera.position.set( 0, 200, 500 );
            
                scene = new THREE.Scene();
                
                //var light = new THREE.AmbientLight(0xffffff);//to light 3d models
                //scene.add(light);
            
                //orbit controls
                controls = new OrbitControls( camera, renderer.domElement );             
                
                /*Widgets*/
                createGUI();
                
                /*Factory Building*/
                factoryBuilding = new FactoryBuilding();
                scene.add(factoryBuilding.draw());
                
                /*Conveyor Belt test*/
                //var cb = new ConveyorBelt();
                //scene.add(cb.draw());

                loadFactory();
            }

            function loadFactory() {
                let loader = new THREE.FileLoader();
                loader.load(
                    'factory.txt', 
                    function (data) {
                        drawProductionLines(data.split('\n'));
                    },
                    function (xhr) {
		                console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
	                },
	                function (err) {
		                console.error('An error happened');
                    }
                );
            }

            function drawProductionLines(productionLines) {
                for (let i = 0; i < productionLines.length; i++) {
                    let lineName = productionLines[i].substr(0, productionLines[i].indexOf(':'));
                    console.log(lineName);

                    let machines = productionLines[i].trim().substr(productionLines[i].indexOf(':') + 1).split(',');

                    let cb = new ConveyorBelt();
                    let line = cb.scaleConveyorBelt(machines.length);
                    line.position.set(-100, 11, i * 50 - 75);
                    scene.add(line);

                    for (let j = 0; j < machines.length; j++) {
                        drawMachine(machines[j]);
                    }
                }
            }

            function drawMachine(machine) {
                console.log(machine);
            }
            
            function animate() {
                requestAnimationFrame( animate );                
                renderer.render( scene, camera );
            }
            
            /*Widget*/
            function createGUI() {
                var settings = {
                    'show roof': false
                };
                
                var gui = new GUI();
                
                var folder1 = gui.addFolder("Visibility");
                folder1.add(settings, 'show roof').onChange(showRoof);
                folder1.open();
            }
            
            /*Show and hide roof/walls*/
            function showRoof(showRoof){
                if(showRoof) { //if walls and roof not showing
                    factoryBuilding.showRoof();
                } else {
                    factoryBuilding.hideRoof();
                }
            }
            
            /*Event Listeners*/
            function onWindowResize() {
                camera.aspect = window.innerWidth/ window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            window.addEventListener('resize', onWindowResize);
            
            init();
            animate();
		</script>
	</body>
</html>
